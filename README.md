# MAX to Telegram Forwarder

Бот для автоматической пересылки сообщений из мессенджера MAX (VK/Сферум) в Telegram.

## Возможности

- Пересылка текстовых сообщений из MAX в Telegram
- Отправка в конкретный топик группы (форума)
- Фильтрация по конкретному пользователю (по ID)
- Фильтрация по имени пользователя (частичное совпадение)
- Поддержка вложений (фото, документы, видео, стикеры)
- Форматирование сообщений с указанием автора и времени
- Надёжное автоматическое переподключение с exponential backoff
- Уведомления администратору об ошибках в личку Telegram

## Установка

### Локально

1. Клонируйте репозиторий:
```bash
git clone <repo-url>
cd fcamx
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните `.env` (см. раздел "Конфигурация")

5. Запустите:
```bash
python main.py
```

### Docker

```bash
docker-compose up -d
```

### Dokploy

1. Создайте новый сервис в Dokploy
2. Укажите путь к репозиторию
3. Добавьте переменные окружения из `.env`
4. Деплой!

## Конфигурация

Все настройки задаются через переменные окружения или файл `.env`:

### MAX настройки

| Переменная | Описание |
|------------|----------|
| `MAX_AUTH_TOKEN` | Токен авторизации из cookies `__oneme_auth` |
| `MAX_CHAT_ID` | ID чата в MAX (из URL: `web.max.ru/im/c{ID}`) |
| `TARGET_USER_ID` | ID пользователя для фильтрации (опционально) |
| `TARGET_USER_NAME` | Имя пользователя для фильтрации (опционально) |
| `USER_NAMES` | Словарь имён: `ID1:Имя1,ID2:Имя2` |

### Telegram настройки

| Переменная | Описание |
|------------|----------|
| `TG_BOT_TOKEN` | Токен бота от @BotFather |
| `TG_CHAT_ID` | ID чата/группы для пересылки сообщений |
| `TG_TOPIC_ID` | ID топика в группе-форуме (опционально) |
| `TG_ADMIN_ID` | ID администратора для уведомлений об ошибках (опционально) |

## Уведомления администратору

Если указан `TG_ADMIN_ID`, бот будет отправлять уведомления в личку при:

| Событие | Когда отправляется |
|---------|-------------------|
| Дисконнект | После 3 неудачных попыток переподключения |
| Ошибка авторизации | Сразу (требует ручного вмешательства) |
| Восстановление | Когда соединение восстановлено |
| Напоминание | Каждые 10 неудачных попыток |

Получить свой `TG_ADMIN_ID` можно у ботов @userinfobot или @getmyid_bot.

## Получение данных

### MAX_AUTH_TOKEN

1. Откройте https://web.max.ru в браузере
2. Войдите в аккаунт
3. Откройте DevTools (F12) → Application → Cookies
4. Скопируйте значение cookie `__oneme_auth` (только значение поля `token`)

### MAX_CHAT_ID

Из URL чата в браузере:
- `web.max.ru/im/c69869938685220` → ID = `69869938685220`

### TARGET_USER_ID

Запустите бота без фильтра (`TARGET_USER_ID=`), напишите сообщение в чат.
В логах увидите ID отправителя:
```
Новое сообщение от User 149919268 (ID: 149919268): текст...
```

### TG_CHAT_ID и TG_TOPIC_ID

**Способ 1: Через веб-версию Telegram**

Откройте нужный топик в https://web.telegram.org. URL будет вида:
```
https://web.telegram.org/a/#-1003574263848_2
```
Где:
- `-1003574263848` — это `TG_CHAT_ID`
- `2` — это `TG_TOPIC_ID`

**Способ 2: Через ссылку на топик**

Ссылка вида `https://t.me/c/3574263848/2`:
- `TG_CHAT_ID` = `-100` + `3574263848` = `-1003574263848`
- `TG_TOPIC_ID` = `2`

**Способ 3: Через Bot API**

1. Создайте бота через @BotFather
2. Добавьте бота в нужную группу/канал
3. Отправьте сообщение в группу
4. Откройте `https://api.telegram.org/bot<TOKEN>/getUpdates`
5. Найдите `chat.id` в ответе

**Важно:** Для групп/каналов ID будет отрицательным (например `-1001234567890`)

## Пример .env

```env
# MAX
MAX_AUTH_TOKEN=An_Sx6HQ9HDiAq5qxLkeXyaKcWAVIDVQ...
MAX_CHAT_ID=69869938685220
TARGET_USER_ID=149919268
USER_NAMES=149919268:Имя Пользователя

# Telegram
TG_BOT_TOKEN=1234567890:AABBccDDeeFFggHHiiJJkkLLmmNNoo
TG_CHAT_ID=-1003574263848
TG_TOPIC_ID=2
TG_ADMIN_ID=123456789
```

## Формат сообщений

Пересылаемые сообщения форматируются так:

```
Имя Пользователя
29 декабря, 12:53

│ Текст сообщения
```

## Архитектура

- `main.py` — основной код бота
- `max_api_fixed.py` — исправленная библиотека MaxAPI с надёжным реконнектом
- `logger.py` — настройка логирования
- `.env` — конфигурация (не коммитится)

## Лицензия

MIT
